<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
        <title>Opentheso</title>

        <link href="../resources/img/icon_opentheso2.png" rel="icon" />

        <link rel="stylesheet" type="text/css" href="../resources/css/all.css" />
        <link rel="stylesheet" type="text/css" href="../resources/css/theme_general.css" />
        <link rel="stylesheet" type="text/css" href="../resources/css/theme_opentheso.css" />
        <link rel="stylesheet" type="text/css" href="../resources/css/composants_opentheso.css" />

        <script type="text/javascript" src="resources/js/scrollToSelectedScript.js"></script>

        <h:outputStylesheet name="primeicons/primeicons.css" library="primefaces"/>
    </h:head>


    <h:body id="page-top">

        <p:idleMonitor timeout="#{connect.timeout}">
            <p:ajax event="idle" listener="#{sessionControl.isTimeout}" />
        </p:idleMonitor>

        <f:metadata>
            <f:viewParam name="idc" value="#{selectedTheso.idConceptFromUri}"/>
            <f:viewParam name="idt" value="#{selectedTheso.idThesoFromUri}"/>
            <f:viewAction action="#{selectedTheso.preRenderView}"/>
        </f:metadata>

        <p:growl id="messageIndex" globalOnly="true" showDetail="true"/>

        <h:panelGroup rendered="#{menuBean.checkIfUserIsConnected()}" id="wrapper" style="height: 100%" >

            <ui:include src="../commun/menu.xhtml" />

            <div id="content-wrapper" style="width: 100%">

                <div>
                    <ui:include src="../commun/header.xhtml" />
                </div>

                <div class="container-fluid">

                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Boite à outils / <span style="color: #f47b2a">Statistiques</span></h1>
                    </div>

                    <h:form id="containerIndex">

                        <div class="col-12" style="height: 100%">
                            <div class="card shadow mb-4" style="height: 100%; padding: 20px; color: #000">
                                <div class="row">
                                    <div class="col-4" style="text-align: right; margin-top: 5px">
                                        <h:outputText style="font-size: 13px; color: #000;" value="#{langueBean.getMsg('statistique.choix_mode')}"/>
                                    </div>
                                    <div class="col-4">
                                        <p:selectOneMenu value="#{statistiqueBean.selectedStatistiqueTypeCode}"
                                                         style="font-size: 15px; background: white; border-color: #43B572; width: 100%">
                                            <f:selectItem itemLabel="#{langueBean.getMsg('statistique.mode.general')}" itemValue="0" />
                                            <f:selectItem itemLabel="#{langueBean.getMsg('statistique.mode.par_concept')}" itemValue="1" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="col-4"/>
                                </div>

                                <div class="row" style="margin-top: 5px">
                                    <div class="col-4" style="text-align: right; margin-top: 5px">
                                        <h:outputText class="control-label" style="font-size: 13px; color: #000;" 
                                                      value="#{langueBean.getMsg('statistique.choix_lang')}"/>
                                    </div>
                                    <div class="col-4">
                                        <p:selectOneMenu id="langue" value="#{statistiqueBean.selectedLanguage}" 
                                                         style="font-size: 15px; background: white; border-color: #43B572; width: 100%">
                                            <f:selectItems value="#{statistiqueBean.languagesOfTheso}" var="langue"
                                                           itemLabel="#{statistiqueBean.formatLanguage(langue.value)}" itemValue="#{langue.code}"/>
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="col-4">
                                        <p:commandButton title="Valider" styleClass="btn btn-primary" 
                                                         update="containerIndex:bloc1 containerIndex:bloc2 resultat2"
                                                         actionListener="#{statistiqueBean.onSelectLanguageType()}" />
                                    </div>        
                                </div>
                            </div>
                        </div>

                        <h:panelGroup id="bloc1" rendered="#{statistiqueBean.conceptTypeVisible}">
                            <div class="col-12" style="height: 100%">
                                <div class="card shadow mb-4" style="height: 100%; padding: 20px; color: #000">
                                    <p:accordionPanel id="filterParams" activeIndex="null">
                                        <p:tab title="#{langueBean.getMsg('statistique.filter_nbr_result')}">
                                            <div class="row">
                                                <div class="col-3" style="margin-top: 5px">
                                                    <h:outputText style="font-size: 13px;" value="#{langueBean.getMsg('statistique.filter_nbr_result.title')}"/>
                                                </div>
                                                <div class="col-3">
                                                    <p:selectOneMenu value="#{statistiqueBean.nbrResultat}" 
                                                                     styleClass="selectOneMenu_custom">
                                                        <f:selectItem itemLabel="50" itemValue="50" />
                                                        <f:selectItem itemLabel="100" itemValue="100" />
                                                        <f:selectItem itemLabel="200" itemValue="200" />
                                                        <f:selectItem itemLabel="500" itemValue="200" />
                                                        <f:selectItem itemLabel="1 000" itemValue="1000" />
                                                        <f:selectItem itemLabel="2 000" itemValue="2000" />
                                                        <f:selectItem itemLabel="5 000" itemValue="5000" />
                                                        <f:selectItem itemLabel="10 000" itemValue="10000" />
                                                    </p:selectOneMenu>
                                                </div>
                                            </div>
                                        </p:tab>
                                        <p:tab title="#{langueBean.getMsg('statistique.filtre_modification_date')}">
                                            <h:panelGrid columns="2" cellpadding="5" style="margin-top: 10px">
                                                <h:outputText style="font-size: 14px;" value="#{langueBean.getMsg('statistique.filtre_modification_date.start')}"/>
                                                <p:datePicker value="#{statistiqueBean.dateDebut}" style="font-size: 13px; margin-left: 10px; 
                                                              background: white; border-color: #43B572"/>

                                                <h:outputText style="font-size: 14px; margin-top: 10px" value="#{langueBean.getMsg('statistique.filtre_modification_date.end')}"/>
                                                <p:datePicker value="#{statistiqueBean.dateFin}" style="font-size: 13px; margin-left: 10px; 
                                                              margin-top: 10px;  background: white; border-color: #43B572"/>

                                            </h:panelGrid>
                                        </p:tab>
                                        <p:tab title="#{langueBean.getMsg('statistique.filtre_collection')}">
                                            <h:panelGrid columns="2" cellpadding="5" style="margin-top: 10px">
                                                <h:outputText style="font-size: 14px" value="#{langueBean.getMsg('statistique.filtre_collection.title')}"/>

                                                <p:autoComplete value="#{statistiqueBean.selectedCollection}" completeMethod="#{statistiqueBean.searchDomaineName}" 
                                                                style="margin-left: 10px; background: white; border-color: #43B572" />
                                            </h:panelGrid>
                                        </p:tab>
                                    </p:accordionPanel>

                                    <div class="row" style="margin-top: 10px">
                                        <div class="col-12" style="text-align: right">
                                            <p:commandButton title="Initialiser" update="containerIndex:filterParams" styleClass="btn btn-secondary"
                                                             actionListener="#{statistiqueBean.clearFilter()}" style="margin-right: 5px" />

                                            <p:commandButton title="#{langueBean.getMsg('statistique.validate')}"
                                                             update="containerIndex:resultat" styleClass="btn btn-primary"
                                                             actionListener="#{statistiqueBean.getStatisticByConcept()}"/>
                                        </div>
                                    </div>

                                    <p:dataTable id="resultat" var="stat" value="#{statistiqueBean.canceptStatistiques}"
                                                 style="margin-top: 10px" paginator="true" rows="10"
                                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                 currentPageReportTemplate="{startRecord}-{endRecord} de {totalRecords} enregistrement"
                                                 rowsPerPageTemplate="5,10,{ShowAll|'Tous'}">

                                        <p:column width="10%" headerText="#{langueBean.getMsg('statistique.id')}" sortBy="#{customer.name}" >
                                            <h:outputText value="#{stat.idConcept}"/>
                                        </p:column>

                                        <p:column width="40%" headerText="#{langueBean.getMsg('statistique.label')}">
                                            <h:outputText value="#{stat.label}"/>
                                        </p:column> 

                                        <p:column width="10%" headerText="#{langueBean.getMsg('statistique.type')}">
                                            <h:outputText value="#{stat.type}"/>
                                        </p:column> 

                                        <p:column width="15%" headerText="#{langueBean.getMsg('statistique.creation_date')}">
                                            <h:outputText value="#{stat.dateCreation}"/>
                                        </p:column> 

                                        <p:column width="15%" headerText="#{langueBean.getMsg('statistique.modification_date')}">
                                            <h:outputText value="#{stat.dateModification}"/>
                                        </p:column>

                                        <p:column width="10%" headerText="#{langueBean.getMsg('statistique.user')}">
                                            <h:outputText value="#{stat.utilisateur}"/>
                                        </p:column>

                                        <p:column width="5%" headerText="Info">
                                            <p:commandButton icon="pi pi-pencil" update="idConceptStat conceptDdetailForm"
                                                             actionListener="#{statistiqueBean.setConceptSelected(stat)}"
                                                             oncomplete="PF('conceptDdetail').show()" process="@this"
                                                             styleClass="edit-button rounded-button ui-button-success"/>
                                        </p:column>
                                    </p:dataTable>

                                    <div class="row">
                                        <div class="col-12">
                                            <p:commandButton title="#{langueBean.getMsg('statistique.exporter_csv')}"
                                                             icon="fas fa-download" styleClass="btn btn-primary"
                                                             update="containerIndex:bloc1 containerIndex:bloc2" >
                                                <p:fileDownload value="#{statistiqueBean.exportStatiqituque()}" />
                                            </p:commandButton>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </h:panelGroup>

                        <h:panelGroup id="bloc2" rendered="#{statistiqueBean.genericTypeVisible}">
                            <div class="col-12" style="height: 100%">
                                <div class="card shadow mb-4" style="height: 100%; padding: 20px; color: #000">
                                    <div class="row">
                                        <div class="col-6">
                                            <h:outputText style="float: right; font-weight: bold;" value="#{langueBean.getMsg('statistique.thesaurus.name')}"/>
                                        </div>
                                        <div class="col-6">
                                            <h:outputText style="float: left;" value="#{selectedTheso.thesoName} (#{selectedTheso.currentIdTheso})"/>
                                        </div>
                                    </div>

                                    <div class="row" style="margin-top: 5px">
                                        <div class="col-6">
                                            <h:outputText style="float: right; font-weight: bold;" value="#{langueBean.getMsg('statistique.concept.nbr')}"/>
                                        </div>
                                        <div class="col-6">
                                            <h:outputText style="float: left;" value="#{statistiqueBean.nbrCanceptByThes}"/>
                                        </div>
                                    </div>

                                    <div class="row" style="margin-top: 5px">
                                        <div class="col-6">
                                            <h:outputText style="float: right; font-weight: bold;" value="#{langueBean.getMsg('statistique.last_modification')}"/>
                                        </div>
                                        <div class="col-6">
                                            <h:outputText style="float: left;" value="#{statistiqueBean.derniereModification}"/>
                                        </div>
                                    </div>

                                    <p:dataTable id="resultat2" var="stat" value="#{statistiqueBean.genericStatistiques}" 
                                                 style="margin-top: 10px" paginator="true" rows="10"
                                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                 currentPageReportTemplate="{startRecord}-{endRecord} de {totalRecords} enregistrement"
                                                 rowsPerPageTemplate="5,10,{ShowAll|'Tous'}">

                                        <p:column width="30%" headerText="#{langueBean.getMsg('statistique.collection')}">
                                            <h:outputText value="#{stat.collection} (#{stat.idCollection})"/>
                                        </p:column>

                                        <p:column width="30%" headerText="#{langueBean.getMsg('statistique.concepts')}">
                                            <h:outputText value="#{stat.conceptsNbr}"/>
                                        </p:column> 

                                        <p:column width="10%" headerText="#{langueBean.getMsg('statistique.untranslated_terms')}">
                                            <h:outputText value="#{stat.termesNonTraduitsNbr}"/>
                                        </p:column> 

                                        <p:column width="10%" headerText="#{langueBean.getMsg('statistique.notes')}">
                                            <h:outputText value="#{stat.notesNbr}"/>
                                        </p:column> 

                                        <p:column width="10%" headerText="Align Wikidata">
                                            <h:outputText value="#{stat.wikidataAlignNbr}"/>
                                        </p:column>

                                        <p:column width="10%" headerText="Total alignement">
                                            <h:outputText value="#{stat.totalAlignment}"/>
                                        </p:column>

                                        <f:facet name="footer">
                                            <span class="p-text-bold">
                                                <h:outputText value="Graphe : "/>
                                                <p:commandLink oncomplete="PF('conceptChart').show();" style="color: #f47b2a; margin-left: 10px" update="conceptChartID">
                                                    <h:outputText style="font-weight: bold;" value="#{langueBean.getMsg('statistique.concepts')}"/>
                                                </p:commandLink>

                                                <p:commandLink oncomplete="PF('termChart').show();" style="color: #f47b2a; margin-left: 10px" update="termChartID">
                                                    <h:outputText style="font-weight: bold;" value="#{langueBean.getMsg('statistique.untranslated_terms')}"/>
                                                </p:commandLink>

                                                <p:commandLink oncomplete="PF('synonymChart').show();" style="color: #f47b2a; margin-left: 10px" update="synonymChartID">
                                                    <h:outputText style="font-weight: bold;" value="#{langueBean.getMsg('statistique.synonyms')}"/>
                                                </p:commandLink>

                                                <p:commandLink oncomplete="PF('noteChart').show();" style="color: #f47b2a; margin-left: 10px" update="noteChartID">
                                                    <h:outputText style="font-weight: bold;" value="#{langueBean.getMsg('statistique.notes')}"/>
                                                </p:commandLink>
                                            </span>
                                        </f:facet>
                                    </p:dataTable>

                                    <p:commandButton icon="fa fa-fw fa-download" styleClass="btn btn-success"
                                                     update="containerIndex:bloc1 containerIndex:bloc2" style="margin-top: 10px" >
                                        <p:fileDownload value="#{statistiqueBean.exportStatiqituque()}" />
                                    </p:commandButton>
                                </div>
                            </div>
                        </h:panelGroup>

                    </h:form>

                    <p:dialog id="noteChartID" widgetVar="noteChart" modal="true" resizable="false" position="top" width="600" style="margin-top: 50px">
                        <div class="card">
                            <p:donutChart widgetVar="chart" model="#{statistiqueBean.createChartModel(4)}" style="width: 100%; height: 500px;"/>
                        </div>
                        <!--<div class="row" style="margin-top: 10px">
                            <p:commandButton type="button" title="Export" icon="pi pi-home" oncomplete="PF('noteChart').hide();"
                                             onclick="$('#output').empty().append(PF('chart').exportAsImage());PF('dlg').show();" />
                        </div>-->
                    </p:dialog>

                    <p:dialog id="termChartID" widgetVar="termChart" modal="true" resizable="false" position="top" width="600" style="margin-top: 50px" >
                        <div class="card">
                            <p:donutChart model="#{statistiqueBean.createChartModel(3)}" style="width: 100%; height: 500px;"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="synonymChartID" widgetVar="synonymChart" modal="true" resizable="false" position="top" width="600" style="margin-top: 50px" >
                        <div class="card">
                            <p:donutChart model="#{statistiqueBean.createChartModel(2)}" style="width: 100%; height: 500px;"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="conceptChartID" widgetVar="conceptChart" modal="true" resizable="false" position="top" width="600" style="margin-top: 50px" >
                        <div class="card">
                            <p:donutChart model="#{statistiqueBean.createChartModel(1)}" style="width: 100%; height: 500px;"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="idConceptStat" header="Détail du concept '#{statistiqueBean.canceptStatistiqueSelected.label}'" 
                              widgetVar="conceptDdetail" modal="true" resizable="true" position="top" width="600" 
                              style="margin-top: 50px" >         

                        <h:form id="conceptDdetailForm">  

                            <div class="row">
                                <div class="col-6">
                                    <h:outputText style="float: right; font-weight: bold;" value="Id concept : "/>
                                </div>
                                <div class="col-6">
                                    <h:outputText style="float: left;" value="#{statistiqueBean.canceptStatistiqueSelected.idConcept}"/>
                                </div>
                            </div>

                            <div class="row" style="margin-top: 5px">
                                <div class="col-6">
                                    <h:outputText style="float: right; font-weight: bold;" value="Type : "/>
                                </div>
                                <div class="col-6">
                                    <h:outputText style="float: left;" value="#{statistiqueBean.canceptStatistiqueSelected.type}"/>
                                </div>
                            </div>

                            <div class="row" style="margin-top: 5px">
                                <div class="col-6">
                                    <h:outputText style="float: right; font-weight: bold;" value="Utilisateur : "/>
                                </div>
                                <div class="col-6">
                                    <h:outputText style="float: left;" value="#{statistiqueBean.canceptStatistiqueSelected.utilisateur}"/>
                                </div>
                            </div>

                            <div class="row" style="margin-top: 5px">
                                <div class="col-6">
                                    <h:outputText style="float: right; font-weight: bold;" value="Date de création : "/>
                                </div>
                                <div class="col-6">
                                    <h:outputText style="float: left;" value="#{statistiqueBean.canceptStatistiqueSelected.dateCreation}"/>
                                </div>
                            </div>

                            <div class="row" style="margin-top: 5px">
                                <div class="col-6">
                                    <h:outputText style="float: right; font-weight: bold;" value="Date de modification : "/>
                                </div>
                                <div class="col-6">
                                    <h:outputText style="float: left;" value="#{statistiqueBean.canceptStatistiqueSelected.dateModification}"/>
                                </div>
                            </div>
                        </h:form>
                    </p:dialog>
                </div>
                <ui:include src="../commun/footer.xhtml" />
            </div>
        </h:panelGroup>
    </h:body>
</html>